<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Snowball Challenge 2025</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
  <style>
    .activity-walk { background-color: #e3f2fd; }
    .activity-run { background-color: #e8f5e9; }
    .activity-ride { background-color: #fff3e0; }
    .snowball { background-color: #f3e5f5; font-weight: bold; }
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .loading-spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 2s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="loading" class="loading">
    <div class="loading-spinner"></div>
  </div>
  
  <div class="container mx-auto px-4 py-8">
    <header class="mb-10 text-center">
      <h1 class="text-4xl font-bold text-indigo-600 mb-2">Snowball Challenge 2025</h1>
      <p class="text-xl text-gray-600">Track your progress and see the leaderboard</p>
    </header>

    <div class="mb-6 text-center">
      <label for="file-upload" class="mb-2 block text-gray-700">Upload your athlete data Excel file:</label>
      <input type="file" id="file-upload" accept=".xlsx,.xls,.csv" class="p-2 border rounded mb-4 mx-auto">
      <p class="text-sm text-gray-500">Or view the dashboard with sample data</p>
    </div>

    <div class="mb-10 flex flex-wrap gap-4 justify-center">
      <div class="bg-white rounded-lg shadow-md p-6 w-full lg:w-1/3">
        <h2 class="text-xl font-semibold mb-4">Total Participants</h2>
        <div id="total-participants" class="text-4xl font-bold text-indigo-600">-</div>
      </div>
      <div class="bg-white rounded-lg shadow-md p-6 w-full lg:w-1/3">
        <h2 class="text-xl font-semibold mb-4">Total Snowball Points</h2>
        <div id="total-points" class="text-4xl font-bold text-indigo-600">-</div>
      </div>
    </div>

    <div class="mb-8">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold">Monthly Overview</h2>
        <select id="chart-type" class="p-2 border rounded">
          <option value="snowball">Snowball Points</option>
          <option value="walk">Walking Distance</option>
          <option value="run">Running Distance</option>
          <option value="ride">Riding Distance</option>
        </select>
      </div>
      <div class="bg-white rounded-lg shadow-md p-6">
        <canvas id="monthly-chart" height="300"></canvas>
      </div>
    </div>

    <div class="mb-8">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold">Leaderboard</h2>
        <div class="flex items-center gap-2">
          <label for="month-filter" class="text-gray-700">Month:</label>
          <select id="month-filter" class="p-2 border rounded">
            <option value="all">All Months</option>
            <option value="January">January</option>
            <option value="February">February</option>
            <option value="March">March</option>
            <option value="April">April</option>
            <option value="May">May</option>
            <option value="June">June</option>
            <option value="July">July</option>
            <option value="August">August</option>
            <option value="September">September</option>
            <option value="October">October</option>
            <option value="November">November</option>
            <option value="December">December</option>
          </select>
          <input type="text" id="search-input" placeholder="Search athletes..." class="p-2 border rounded">
        </div>
      </div>
      <div class="overflow-x-auto">
        <table id="leaderboard-table" class="min-w-full bg-white rounded-lg shadow-md">
          <thead>
            <tr class="bg-gray-200 text-gray-700">
              <th class="py-3 px-4 text-left">Rank</th>
              <th class="py-3 px-4 text-left">Athlete</th>
              <th class="py-3 px-4 text-right">Walk (km)</th>
              <th class="py-3 px-4 text-right">Run (km)</th>
              <th class="py-3 px-4 text-right">Ride (km)</th>
              <th class="py-3 px-4 text-right">Snowball Points</th>
            </tr>
          </thead>
          <tbody id="leaderboard-body">
            <tr>
              <td colspan="6" class="py-3 px-4 text-center">Upload data to see the leaderboard</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="mb-8">
      <h2 class="text-2xl font-bold mb-4">Athlete Detail</h2>
      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="mb-4">
          <label for="athlete-select" class="block text-gray-700 mb-2">Select Athlete:</label>
          <select id="athlete-select" class="w-full p-2 border rounded">
            <option value="">Select an athlete...</option>
          </select>
        </div>
        <div id="athlete-detail" class="hidden">
          <h3 id="athlete-name" class="text-xl font-semibold mb-4"></h3>
          <div class="overflow-x-auto">
            <table class="min-w-full bg-white">
              <thead>
                <tr class="bg-gray-200 text-gray-700">
                  <th class="py-2 px-3 text-left">Month</th>
                  <th class="py-2 px-3 text-right">Walk (km)</th>
                  <th class="py-2 px-3 text-right">Run (km)</th>
                  <th class="py-2 px-3 text-right">Ride (km)</th>
                  <th class="py-2 px-3 text-right">Snowball Points</th>
                </tr>
              </thead>
              <tbody id="athlete-stats">
              </tbody>
            </table>
          </div>
          <div class="mt-6">
            <canvas id="athlete-chart" height="250"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
      <h2 class="text-2xl font-bold mb-4">About the Snowball Challenge</h2>
      <div class="prose max-w-none">
        <p>The Snowball Challenge 2025 is a year-long competition that tracks your walking, running, and cycling activities. Points are calculated with different multipliers for each activity type:</p>
        <ul>
          <li><strong>Walking:</strong> 3× multiplier</li>
          <li><strong>Running:</strong> 4× multiplier</li>
          <li><strong>Riding:</strong> 1× multiplier</li>
        </ul>
        <p>Activities are tracked through Strava and are updated regularly. Keep challenging yourself to reach new heights!</p>
      </div>
    </div>

    <footer class="text-center text-gray-600 py-4">
      <p>© 2025 Snowball Challenge. Data sourced from Strava API.</p>
    </footer>
  </div>

  <script>
    // Global variables
    let athletesData = [];
    let monthlyChart = null;
    let athleteChart = null;
    const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    
    // Activity multipliers (as defined in your Python code)
    const activityMultipliers = {
      "Walk": 3,
      "Run": 4,
      "Ride": 1
    };

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      // Set up event listeners
      document.getElementById('file-upload').addEventListener('change', handleFileUpload);
      document.getElementById('month-filter').addEventListener('change', updateLeaderboard);
      document.getElementById('search-input').addEventListener('input', updateLeaderboard);
      document.getElementById('chart-type').addEventListener('change', updateMonthlyChart);
      document.getElementById('athlete-select').addEventListener('change', displayAthleteDetail);
      
      // Load sample data if no file is uploaded within 3 seconds
      setTimeout(() => {
        if (athletesData.length === 0) {
          loadSampleData();
        }
      }, 3000);
    });

    // Handle file upload
    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      showLoading();

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          athletesData = XLSX.utils.sheet_to_json(worksheet);
          
          processData();
          hideLoading();
        } catch (error) {
          console.error('Error processing file:', error);
          alert('Error processing file. Please make sure it\'s a valid Excel file.');
          hideLoading();
        }
      };
      reader.onerror = function() {
        alert('Error reading file');
        hideLoading();
      };
      reader.readAsArrayBuffer(file);
    }

    // Load sample data
    function loadSampleData() {
      showLoading();
      
      // Create sample data that matches your Excel structure
      athletesData = [];
      
      // Add 10 sample athletes
      for (let i = 1; i <= 10; i++) {
        const athlete = {
          athlete_id: 1000 + i,
          firstname: `Athlete${i}`,
          lastname: `Runner`
        };
        
        // Add monthly data for each activity type
        let totalPoints = 0;
        months.forEach(month => {
          // Generate random distances
          const walkDistance = Math.random() * 50;
          const runDistance = Math.random() * 30;
          const rideDistance = Math.random() * 100;
          
          // Calculate snowball points
          const snowballPoints = 
            walkDistance * activityMultipliers.Walk + 
            runDistance * activityMultipliers.Run + 
            rideDistance * activityMultipliers.Ride;
          
          // Add to athlete object
          athlete[`${month}_Walk`] = walkDistance;
          athlete[`${month}_Run`] = runDistance;
          athlete[`${month}_Ride`] = rideDistance;
          athlete[`${month}_snowball`] = snowballPoints;
          
          totalPoints += snowballPoints;
        });
        
        // Add some variety
        if (i === 3) {
          // Make this athlete a walker
          months.forEach(month => {
            athlete[`${month}_Walk`] *= 2;
            athlete[`${month}_Run`] /= 2;
            athlete[`${month}_snowball`] = 
              athlete[`${month}_Walk`] * activityMultipliers.Walk + 
              athlete[`${month}_Run`] * activityMultipliers.Run + 
              athlete[`${month}_Ride`] * activityMultipliers.Ride;
          });
        } else if (i === 5) {
          // Make this athlete a runner
          months.forEach(month => {
            athlete[`${month}_Walk`] /= 2;
            athlete[`${month}_Run`] *= 2;
            athlete[`${month}_snowball`] = 
              athlete[`${month}_Walk`] * activityMultipliers.Walk + 
              athlete[`${month}_Run`] * activityMultipliers.Run + 
              athlete[`${month}_Ride`] * activityMultipliers.Ride;
          });
        } else if (i === 7) {
          // Make this athlete a rider
          months.forEach(month => {
            athlete[`${month}_Walk`] /= 2;
            athlete[`${month}_Ride`] *= 3;
            athlete[`${month}_snowball`] = 
              athlete[`${month}_Walk`] * activityMultipliers.Walk + 
              athlete[`${month}_Run`] * activityMultipliers.Run + 
              athlete[`${month}_Ride`] * activityMultipliers.Ride;
          });
        }
        
        athletesData.push(athlete);
      }
      
      processData();
      hideLoading();
    }

    // Process the data and update UI
    function processData() {
      updateAthletesDropdown();
      updateDashboardSummary();
      updateMonthlyChart();
      updateLeaderboard();
    }

    // Update the athletes dropdown
    function updateAthletesDropdown() {
      const athleteSelect = document.getElementById('athlete-select');
      athleteSelect.innerHTML = '<option value="">Select an athlete...</option>';
      
      athletesData.forEach(athlete => {
        const fullName = `${athlete.firstname} ${athlete.lastname}`;
        const option = document.createElement('option');
        option.value = athlete.athlete_id;
        option.textContent = fullName;
        athleteSelect.appendChild(option);
      });
    }

    // Update dashboard summary
    function updateDashboardSummary() {
      document.getElementById('total-participants').textContent = athletesData.length;
      
      let totalPoints = 0;
      athletesData.forEach(athlete => {
        months.forEach(month => {
          totalPoints += athlete[`${month}_snowball`] || 0;
        });
      });
      
      document.getElementById('total-points').textContent = Math.round(totalPoints).toLocaleString();
    }

    // Update monthly chart
    function updateMonthlyChart() {
      const chartType = document.getElementById('chart-type').value;
      const ctx = document.getElementById('monthly-chart').getContext('2d');
      
      const monthlyTotals = months.map(month => {
        let total = 0;
        athletesData.forEach(athlete => {
          if (chartType === 'snowball') {
            total += athlete[`${month}_snowball`] || 0;
          } else {
            total += athlete[`${month}_${chartType.charAt(0).toUpperCase() + chartType.slice(1)}`] || 0;
          }
        });
        return total;
      });
      
      const chartTitle = chartType === 'snowball' 
        ? 'Monthly Snowball Points'
        : `Monthly ${chartType.charAt(0).toUpperCase() + chartType.slice(1)}ing Distance (km)`;
      
      const chartColor = {
        'snowball': 'rgba(156, 39, 176, 0.7)',
        'walk': 'rgba(33, 150, 243, 0.7)',
        'run': 'rgba(76, 175, 80, 0.7)',
        'ride': 'rgba(255, 152, 0, 0.7)'
      };
      
      if (monthlyChart) {
        monthlyChart.destroy();
      }
      
      monthlyChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: months,
          datasets: [{
            label: chartTitle,
            data: monthlyTotals,
            backgroundColor: chartColor[chartType],
            borderColor: chartColor[chartType].replace('0.7', '1'),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false
            },
            title: {
              display: true,
              text: chartTitle,
              font: {
                size: 16
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return Math.round(value).toLocaleString();
                }
              }
            }
          }
        }
      });
    }

    // Update leaderboard table
    function updateLeaderboard() {
      const monthFilter = document.getElementById('month-filter').value;
      const searchInput = document.getElementById('search-input').value.toLowerCase();
      const tableBody = document.getElementById('leaderboard-body');
      
      // Clear the table
      tableBody.innerHTML = '';
      
      // Create a copy of the athletes data for sorting
      const sortedAthletes = [...athletesData];
      
      // Calculate totals for the selected month or all months
      sortedAthletes.forEach(athlete => {
        let totalWalk = 0;
        let totalRun = 0;
        let totalRide = 0;
        let totalSnowball = 0;
        
        if (monthFilter === 'all') {
          months.forEach(month => {
            totalWalk += athlete[`${month}_Walk`] || 0;
            totalRun += athlete[`${month}_Run`] || 0;
            totalRide += athlete[`${month}_Ride`] || 0;
            totalSnowball += athlete[`${month}_snowball`] || 0;
          });
        } else {
          totalWalk = athlete[`${monthFilter}_Walk`] || 0;
          totalRun = athlete[`${monthFilter}_Run`] || 0;
          totalRide = athlete[`${monthFilter}_Ride`] || 0;
          totalSnowball = athlete[`${monthFilter}_snowball`] || 0;
        }
        
        athlete.totalWalk = totalWalk;
        athlete.totalRun = totalRun;
        athlete.totalRide = totalRide;
        athlete.totalSnowball = totalSnowball;
      });
      
      // Sort by total snowball points
      sortedAthletes.sort((a, b) => b.totalSnowball - a.totalSnowball);
      
      // Filter by search input
      const filteredAthletes = sortedAthletes.filter(athlete => {
        const fullName = `${athlete.firstname} ${athlete.lastname}`.toLowerCase();
        return fullName.includes(searchInput);
      });
      
      // Create table rows
      filteredAthletes.forEach((athlete, index) => {
        const fullName = `${athlete.firstname} ${athlete.lastname}`;
        
        // Skip if no activity in the selected month
        if (athlete.totalWalk === 0 && athlete.totalRun === 0 && athlete.totalRide === 0) {
          return;
        }
        
        const row = document.createElement('tr');
        row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
        row.innerHTML = `
          <td class="py-3 px-4">${index + 1}</td>
          <td class="py-3 px-4">${fullName}</td>
          <td class="py-3 px-4 text-right activity-walk">${athlete.totalWalk.toFixed(1)}</td>
          <td class="py-3 px-4 text-right activity-run">${athlete.totalRun.toFixed(1)}</td>
          <td class="py-3 px-4 text-right activity-ride">${athlete.totalRide.toFixed(1)}</td>
          <td class="py-3 px-4 text-right snowball">${Math.round(athlete.totalSnowball).toLocaleString()}</td>
        `;
        
        // Add click event to show athlete detail
        row.style.cursor = 'pointer';
        row.addEventListener('click', function() {
          document.getElementById('athlete-select').value = athlete.athlete_id;
          displayAthleteDetail();
        });
        
        tableBody.appendChild(row);
      });
      
      // Show message if no results
      if (filteredAthletes.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="6" class="py-3 px-4 text-center">No athletes found</td>
        `;
        tableBody.appendChild(row);
      }
    }

    // Display athlete detail
    function displayAthleteDetail() {
      const athleteId = document.getElementById('athlete-select').value;
      const athleteDetail = document.getElementById('athlete-detail');
      const athleteStats = document.getElementById('athlete-stats');
      
      if (!athleteId) {
        athleteDetail.classList.add('hidden');
        return;
      }
      
      const athlete = athletesData.find(a => a.athlete_id.toString() === athleteId.toString());
      
      if (!athlete) {
        athleteDetail.classList.add('hidden');
        return;
      }
      
      // Show the detail section
      athleteDetail.classList.remove('hidden');
      
      // Set athlete name
      document.getElementById('athlete-name').textContent = `${athlete.firstname} ${athlete.lastname}`;
      
      // Clear stats table
      athleteStats.innerHTML = '';
      
      // Prepare data for chart
      const chartData = {
        labels: months,
        datasets: [
          {
            label: 'Walk (km × 3)',
            data: [],
            backgroundColor: 'rgba(33, 150, 243, 0.5)',
            borderColor: 'rgba(33, 150, 243, 1)',
            borderWidth: 1
          },
          {
            label: 'Run (km × 4)',
            data: [],
            backgroundColor: 'rgba(76, 175, 80, 0.5)',
            borderColor: 'rgba(76, 175, 80, 1)',
            borderWidth: 1
          },
          {
            label: 'Ride (km × 1)',
            data: [],
            backgroundColor: 'rgba(255, 152, 0, 0.5)',
            borderColor: 'rgba(255, 152, 0, 1)',
            borderWidth: 1
          }
        ]
      };
      
      // Add rows for each month
      let yearTotalWalk = 0;
      let yearTotalRun = 0;
      let yearTotalRide = 0;
      let yearTotalSnowball = 0;
      
      months.forEach(month => {
        const walkDistance = athlete[`${month}_Walk`] || 0;
        const runDistance = athlete[`${month}_Run`] || 0;
        const rideDistance = athlete[`${month}_Ride`] || 0;
        const snowballPoints = athlete[`${month}_snowball`] || 0;
        
        // Add data for chart
        chartData.datasets[0].data.push(walkDistance);
        chartData.datasets[1].data.push(runDistance);
        chartData.datasets[2].data.push(rideDistance);
        
        // Skip months with no activity
        if (walkDistance === 0 && runDistance === 0 && rideDistance === 0) {
          return;
        }
        
        // Create row
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="py-2 px-3">${month}</td>
          <td class="py-2 px-3 text-right activity-walk">${walkDistance.toFixed(1)}</td>
          <td class="py-2 px-3 text-right activity-run">${runDistance.toFixed(1)}</td>
          <td class="py-2 px-3 text-right activity-ride">${rideDistance.toFixed(1)}</td>
          <td class="py-2 px-3 text-right snowball">${Math.round(snowballPoints).toLocaleString()}</td>
        `;
        athleteStats.appendChild(row);
        
        // Add to year totals
        yearTotalWalk += walkDistance;
        yearTotalRun += runDistance;
        yearTotalRide += rideDistance;
        yearTotalSnowball += snowballPoints;
      });
      
      // Add year total row
      const totalRow = document.createElement('tr');
      totalRow.className = 'bg-gray-200 font-bold';
      totalRow.innerHTML = `
        <td class="py-2 px-3">Year Total</td>
        <td class="py-2 px-3 text-right activity-walk">${yearTotalWalk.toFixed(1)}</td>
        <td class="py-2 px-3 text-right activity-run">${yearTotalRun.toFixed(1)}</td>
        <td class="py-2 px-3 text-right activity-ride">${yearTotalRide.toFixed(1)}</td>
        <td class="py-2 px-3 text-right snowball">${Math.round(yearTotalSnowball).toLocaleString()}</td>
      `;
      athleteStats.appendChild(totalRow);
      
      // Create athlete chart
      updateAthleteChart(chartData);
    }

    // Update athlete chart
    function updateAthleteChart(chartData) {
      const ctx = document.getElementById('athlete-chart').getContext('2d');
      
      if (athleteChart) {
        athleteChart.destroy();
      }
      
      athleteChart = new Chart(ctx, {
        type: 'bar',
        data: chartData,
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Monthly Activity Breakdown',
              font: {
                size: 16
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Distance (km)'
              }
            },
            x: {
              stacked: false
            }
          }
        }
      });
    }

    // Show loading indicator
    function showLoading() {
      document.getElementById('loading').style.display = 'flex';
    }

    // Hide loading indicator
    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }
  </script>
</body>
</html>
